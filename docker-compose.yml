version: '3.5'

services:
  db:
    container_name: ${MY_NAME}_db
    image: mariadb:latest
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
    networks:
      - nginx_net
    volumes:
      - ${BIND_DIR}/mysql:/var/lib/mysql
    ports:
      - "127.0.0.1:${MYSQL_PORT}:3306"

  periodic-backup:
    ## this sections uses work from https://github.com/ricardolsmendes/docker-samples/
    container_name: ${MY_NAME}_database-backup
    build: ./periodic_backup
    environment:
      MYSQL_CONTAINER_NAME: ${MY_NAME}_db
      MYSQL_DATABASE: ${MYSQL_DATABASE}
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_KEEP_BACKUP_DAYS: ${MYSQL_KEEP_BACKUP_DAYS}
    networks:
      - nginx_net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - ${BIND_DIR}/backup:/backup
    command: crond -f -d 8
    restart: always

  web:
    container_name: ${MY_NAME}_nginx_php-fpm
    image: ${IMAGE_NAME}:${IMAGE_TAG}
    build: .
    restart: always
    ports:
      - ${WEB_PORT}:8080
    networks:
      - nginx_net
    depends_on:
      - "db"
    volumes:
      - ${BIND_DIR}/var/www:/var/www
#      - nginx-config:/etc/nginx
#      - php-config:/etc/php81

  adminer:
    container_name: ${MY_NAME}_adminer
    image: adminer
    restart: always
    environment:
      ADMINER_DESIGN: mvt
      # enabling the next line is less secure
      #ADMINER_DEFAULT_SERVER: ${MY_NAME}_db
    ports:
      - ${ADMINER_PORT}:8080
    networks:
      - nginx_net
    depends_on:
      - "db"

#  set_once:
#    container_name: ${MY_NAME}_set-once
#    build: ./settings
#    restart: unless-stopped
#    volumes:
#      - nginx-config:/etc/nginx
#      - php-config:/etc/php81

  grafana:
    image: grafana/grafana-enterprise
    container_name: ${MY_NAME}_grafana
    user: "$UID:$GID"
    restart: unless-stopped
    environment:
     - GF_SERVER_ROOT_URL=http://localhost/
     - GF_INSTALL_PLUGINS=grafana-clock-panel
     - GF_AUTH_ANONYMOUS_ENABLED=${GF_AUTH_ANONYMOUS_ENABLED}
     - GF_SECURITY_ALLOW_EMBEDDING=${GF_SECURITY_ALLOW_EMBEDDING}
    ports:
     - ${GRAFANA_PORT}:3000
    networks:
      - nginx_net
    volumes:
      - ${BIND_DIR}/grafana/var/lib/grafana:/var/lib/grafana
    depends_on:
      - "db"

networks:
  nginx_net:
    driver: bridge

#volumes:
#  nginx-config:
#  php-config:

#sut:
#    image: alpine:3.13
#    depends_on:
#      - app
#    command: /tmp/run_tests.sh
#    volumes:
#      - "./run_tests.sh:/tmp/run_tests.sh:ro"
